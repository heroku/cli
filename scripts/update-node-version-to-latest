#!/bin/bash

# Get the last line of the version output
last_line=$(npm show node@22 version | tail -n 1)

# Extract the second token using awk and remove quotes
version=$(echo "$last_line" | awk '{print $2}' | tr -d "'")

if [ -z "$version" ]; then
    echo "Error: Could not extract version number" >&2
    exit 1
fi

# Update the nodejs line in .tool-versions file
# If nodejs line exists, replace it; if not, append it
if grep -q "^nodejs" .tool-versions; then
    sed -i '' "s/^nodejs.*$/nodejs $version/" .tool-versions
else
    echo "nodejs $version" >> .tool-versions
fi

# Install the Node.js version via asdf to ensure it's available
echo "Installing Node.js version $version via asdf..."
if asdf install nodejs "$version"; then
    echo "Successfully installed Node.js version $version"
else
    echo "Warning: Failed to install Node.js version $version via asdf" >&2
    echo "Continuing with package.json update..." >&2
fi

# Update the Node.js version in package.json oclif config
# Using node to update the JSON file
package_file="./package.json"
if [ -f "$package_file" ]; then
    node -e "
        const fs = require('fs');
        const pkg = JSON.parse(fs.readFileSync('$package_file', 'utf-8'));
        if (pkg.oclif && pkg.oclif.update && pkg.oclif.update.node) {
            pkg.oclif.update.node.version = '$version';
            fs.writeFileSync('$package_file', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated nodejs version to $version in package.json');
        } else {
            console.error('Error: Could not find oclif.update.node in package.json');
            process.exit(1);
        }
    "
    echo "Updated nodejs version to $version in .tool-versions and package.json"
else
    echo "Error: Could not find $package_file" >&2
    exit 1
fi
