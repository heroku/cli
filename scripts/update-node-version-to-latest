#!/bin/bash

# Get the last line of the version output
last_line=$(npm show node@22 version | tail -n 1)

# Extract the second token using awk and remove quotes
version=$(echo "$last_line" | awk '{print $2}' | tr -d "'")

if [ -z "$version" ]; then
    echo "Error: Could not extract version number" >&2
    exit 1
fi

# Update the nodejs line in .tool-versions file
# If nodejs line exists, replace it; if not, append it
if grep -q "^nodejs" .tool-versions; then
    sed -i '' "s/^nodejs.*$/nodejs $version/" .tool-versions
else
    echo "nodejs $version" >> .tool-versions
fi

# Install the Node.js version via asdf to ensure it's available
echo "Installing Node.js version $version via asdf..."
if asdf install nodejs "$version"; then
    echo "Successfully installed Node.js version $version"
else
    echo "Warning: Failed to install Node.js version $version via asdf" >&2
    echo "Continuing with oclif.config.mjs update..." >&2
fi

# Update the Node.js version in oclif.config.mjs
# Using sed to update the version field in the oclif config
config_file="packages/cli/oclif.config.mjs"
if [ -f "$config_file" ]; then
    sed -i '' "s/version: '[^']*',/version: '$version',/" "$config_file"
    echo "Updated nodejs version to $version in .tool-versions and oclif.config.mjs"
else
    echo "Error: Could not find $config_file" >&2
    exit 1
fi
